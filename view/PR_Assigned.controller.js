/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.require("sap.ca.scfld.md.controller.BaseFullscreenController");jQuery.sap.require("ui.s2p.mm.purord.fromrequisition.util.Formatter");jQuery.sap.require("sap.ca.ui.utils.busydialog");sap.ca.scfld.md.controller.BaseFullscreenController.extend("ui.s2p.mm.purord.fromrequisition.view.PR_Assigned",{onInit:function(){this.skip=0;this.packagesize=100;this.orderby="DeliveryDate desc";this.orderbyAttr="DeliveryDate";this.assignedPRs_all=0;this.assignedPRs_ui=0;this.oBundle=sap.ca.scfld.md.app.Application.getImpl().getResourceBundle();this.bResponderOn=jQuery.sap.getUriParameters().get("responderOn");var l=this.oList=this.byId("pralist");this.oTableModel=new sap.ui.model.json.JSONModel();this.oAutoAssignModel=new sap.ui.model.json.JSONModel();var b=sap.ui.getCore().getEventBus();b.subscribe("ui.s2p.mm.purord.fromrequisition.publish","assignedPRs",this.receiveAssignedPRs,this);b.subscribe("ui.s2p.mm.purord.fromrequisition.publish","assignedBackendPRs",this.receiveAssBackendPRs,this);b.subscribe("ui.s2p.mm.purord.fromrequisition.popup","selection",this.receiveSelection,this);b.subscribe("ui.s2p.mm.purord.fromrequisition.trigger","loadAssignedPRs",this.loadAssignedPRs,this);this.poSimulatedCount=0;if(this.bResponderOn){var p="/ui.s2p.mm.purord.fromrequisition/mock/unassignedPRsLikeMockup.json";this.oTableModel.loadData(p,"",true);if(l){l.setModel(this.oTableModel,"PR_ass_model");var t=this.byId("listitem");if(t){l.bindItems("/PRItemCollectionAss",t)}}}},onBeforeRendering:function(){if(this.bResponderOn){}else{if(this.oAutoAssignModel.oData&&this.oAutoAssignModel.oData.PRItemCollection&&this.oAutoAssignModel.oData.PRItemCollection.length>0){jQuery.merge(this.oTableModel.oData.PRItemCollection,this.oAutoAssignModel.oData.PRItemCollection);this.oAutoAssignModel.setData({"PRItemCollection":[]});this.refreshList()}}},removeItemsFromModels:function(p,l){for(var i=0;i<l.length;i++){p.splice(l[i],1)}},removeSelectionFromListItem:function(p){var I=this.oList.getSelectedItems();for(var i=0;i<I.length;i++){if(I[i].getCells()[0].getText()===p){this.oList.setSelectedItem(I[i],false);break}}},onCreatePOSimulated:function(e){var I=[];var c=undefined;var p=undefined;var P=[];function s(d,r){var S=undefined;var f=[];var b=undefined;var t=undefined;var n={results:[]};var g;var G=0;sap.ca.ui.utils.busydialog.releaseBusyDialog();for(b=0;b<d.results.length;++b){if(d.results[b].Error==""){n.results.push(d.results[b]);for(var h=0;h<d.results[b].POProposalItemCollection.results.length;++h){f.push(d.results[b].POProposalItemCollection.results[h].PRKey)}}}S=new sap.ui.model.json.JSONModel({results:[]});g=S.getData();if(g){g.results=n.results;for(b=0;b<g.results.length;++b){G++;g.results[b].PONumber=G;g.results[b].PONumberFormatted=G}S.setData(g,false);this.poSimulatedCount=g.results.length}sap.ui.controller("ui.s2p.mm.purord.fromrequisition.view.PO_Simulated").oParams.oModel=S;t=this.oTableModel.getData();var l=[];for(b=t.PRItemCollection.length-1;b>=0;b--){for(h=0;h<f.length;++h){if(t.PRItemCollection[b].PRKey==f[h]){var j=ui.s2p.mm.purord.fromrequisition.util.Formatter.formatPRItem(t.PRItemCollection[b].PRNumberFormatted,t.PRItemCollection[b].PRItemFormatted);this.removeSelectionFromListItem(j);l.push(b);break}}}this.removeItemsFromModels(t.PRItemCollection,l);if(this.oList){this.oTableModel.refresh();this.oList.setModel(null);this.oList.setModel(this.oTableModel,"PR_ass_model")}var m=n.results.length;var q=this.previousSimulationPRItemCounter+this.selectedPRItemCounter;var M="";if(m==1){M=this.oBundle.getText("view.POfromPR_Messages.create_sing1",[q])}else{M=this.oBundle.getText("view.POfromPR_Messages.create_plu",[this.poSimulatedCount,q])}jQuery.sap.require("sap.m.MessageToast");sap.m.MessageToast.show(M,{width:"30em",duration:6000});sap.ui.getCore().getEventBus().publish("ui.s2p.mm.purord.fromrequisition.publish","count",{count_posimulated:this.poSimulatedCount,});this.assignedPRs_all-=this.selectedPRItemCounter;this.assignedPRs_ui-=this.selectedPRItemCounter;sap.ui.getCore().getEventBus().publish("ui.s2p.mm.purord.fromrequisition.publish","count",{count_prassigned:this.assignedPRs_all,count_loaded:this.assignedPRs_ui})};function a(E){sap.ca.ui.utils.busydialog.releaseBusyDialog();var d="";var m=this.oBundle.getText('view.POfromPR.general_error_simulate_message');if((E.message&&E.response)){d=E.message+"\n"+E.response.requestUri+"\n"+E.response.statusText}ui.s2p.mm.purord.fromrequisition.Common.ShowErrorMessage(m,d)};if(this.oList){I=this.oList.getSelectedItems()}this.selectedPRItemCounter=0;for(var i=0;i<I.length;i++){c=I[i].getBindingContext("PR_ass_model");if(!c.getProperty("Error")){P.push(c.getProperty("PRSourceKeys"));this.selectedPRItemCounter++}}this.previousSimulationPRItemCounter=0;var A=sap.ui.controller("ui.s2p.mm.purord.fromrequisition.view.PO_Simulated").oParams.oModel;if(A){var o=A.getData();for(var b=0;b<o.results.length;++b){var k=o.results[b].PRSourceKeys;if(k!=""){P.push(k);this.previousSimulationPRItemCounter+=o.results[b].POProposalItemCollection.results.length}}}p=P.join(",");var u="PRSourceKey="+"'"+p+"'";sap.ca.ui.utils.busydialog.requireBusyDialog();var B=this.oView.getModel();B.read("CreatePOProposal",null,[u,"$expand=POProposalItemCollection"],true,jQuery.proxy(s,this),jQuery.proxy(a,this))},refreshList:function(){if(this.oList){this.oList.setModel(null);this.oList.setModel(this.oTableModel,"PR_ass_model");this.oTableModel.refresh();if(this.orderbyAttr){ui.s2p.mm.purord.fromrequisition.Common.sortList(this.oList,this.orderbyAttr,true)}}},getList:function(){return this.byId("pralist")},receiveAssignedPRs:function(c,e,d){if(this.oAutoAssignModel.oData&&this.oAutoAssignModel.oData.PRItemCollection&&this.oAutoAssignModel.oData.PRItemCollection.length>0){jQuery.merge(this.oAutoAssignModel.oData.PRItemCollection,d.oModel.oData.PRItemCollection)}else{this.oAutoAssignModel=d.oModel}var i=d.oModel.oData.PRItemCollection.length;this.assignedPRs_all+=i;this.assignedPRs_ui+=i;sap.ui.getCore().getEventBus().publish("ui.s2p.mm.purord.fromrequisition.publish","count",{count_prassigned:this.assignedPRs_all,count_loaded:this.assignedPRs_ui})},loadAssignedPRs:function(){if(this.oDataModel===undefined||this.oDataModel===null){this.oDataModel=this.oView.getModel("backendModel")}var s="$skip="+this.skip;var t="$top="+this.packagesize;var o="$orderby="+this.orderby;this.loadDataforView(s,t,o)},loadDataforView:function(s,t,o){var T=this.oBundle.getText("view.POfromPR.loading_assigned");if(this.oList){this.oList.setNoDataText(T)}sap.ui.getCore().getEventBus().publish("ui.s2p.mm.purord.fromrequisition.publish","count",{count_prassigned:this.oBundle.getText("view.POfromPR.counter_loading")});this.oDataModel.read('PRItemCollection',null,[s,"$expand=SourcesOfSupplyCollection",t,o,"$filter=SupplierId ne '' "],true,jQuery.proxy(this.receiveAssBackendPRs,this),jQuery.proxy(function(e){sap.ca.ui.utils.busydialog.releaseBusyDialog();var d="";var m=this.oBundle.getText('view.POfromPR.general_error_assigned_message');if(this.oList){this.oList.setNoDataText(m)}if(e.message&&e.response){d=e.message+"\n"+e.response.requestUri+"\n"+e.response.statusText}ui.s2p.mm.purord.fromrequisition.Common.ShowErrorMessage(m,d)},this))},receiveAssBackendPRs:function(d,r){if(this.oList){this.oList.setNoDataText("")}this.assignedPRs_all=parseInt(d.__count);this.assignedPRs_ui+=d.results.length;var e=null;jQuery.each(d.results,function(k,v){v.SupplierMultiple=false;v.ItemSelected=true;if(v.SourcesOfSupplyCollection&&v.SourcesOfSupplyCollection.results&&v.SourcesOfSupplyCollection.results.length===1){v.Error=v.SourcesOfSupplyCollection.results[0].Error;e=true}});this.oTableModel.setData({"PRItemCollection":d.results});this.refreshList();sap.ui.getCore().getEventBus().publish("ui.s2p.mm.purord.fromrequisition.publish","count",{count_prassigned:this.assignedPRs_all,count_loaded:this.assignedPRs_ui});if(e){sap.ui.getCore().getEventBus().publish("ui.s2p.mm.purord.fromrequisition.publish","updateIconTabColor",{btnPRassignedColor:sap.ui.core.IconColor.Negative})}else{sap.ui.getCore().getEventBus().publish("ui.s2p.mm.purord.fromrequisition.publish","updateIconTabColor",{btnPRassignedColor:sap.ui.core.IconColor.Positive})}},receiveSelection:function(c,e,d){if(d.sOrigin==="PR_List"){if(this.oAutoAssignModel.oData&&this.oAutoAssignModel.oData.PRItemCollection){jQuery.merge(this.oAutoAssignModel.oData.PRItemCollection,[d.oPRItem])}else{this.oAutoAssignModel.setData({"PRItemCollection":[d.oPRItem]})}this.assignedPRs_all+=1;this.assignedPRs_ui+=1;sap.ui.getCore().getEventBus().publish("ui.s2p.mm.purord.fromrequisition.publish","count",{count_prassigned:this.assignedPRs_all,count_loaded:this.assignedPRs_ui})}},onSupplierChange:function(e){if(!this.oSupplierPopup){if(this.oList){this.oSupplierPopup=ui.s2p.mm.purord.fromrequisition.Common.getSupplierPopup(this.oTableModel,this.getView().getModel("i18n"),this.oRouter);this.oSupplierPopup.sOrigin="PR_Assigned";this.oSupplierPopup.setTitle(this.oBundle.getText("view.POfromPR.assign_tit"))}}if(!this.oSupplierPopup){return}var s='';var p=e.getSource().getBindingContext("PR_ass_model").getPath();if(this.bResponderOn){s=p+"/SourcesOfSupplyCollection"}else{s=p+"/SourcesOfSupplyCollection/results"}var b=sap.ui.getCore().getEventBus();b.publish("ui.s2p.mm.purord.fromrequisition.supplier","path",{path:s,itempath:p,backendModel:this.oList.getModel("PR_ass_model"),});this.oSupplierPopup.openBy(e.getSource())},onSupplierLink:function(e){var c=e.getSource().getBindingContext("PR_ass_model");var s=c.getProperty("SupplierId");if(s===""){var p=c.getProperty("SupplyingPlantDescription");var i=this.oBundle.getText("view.PR_Assigned.sos_plant",[p]);var l=new sap.m.Label();l.addStyleClass("sapMContainerMargin");if(!this.oPlantPopup){var t=this.oBundle.getText("view.PO_List.plant");this.oPlantPopup=new sap.m.Popover({title:t,placement:sap.m.PlacementType.Right,content:l})}this.oPlantPopup.getContent()[0].setText(i);this.oPlantPopup.openBy(e.getSource())}else{this.oRouter.navTo("supplier",{supplierId:c.getProperty("SupplierId"),companyCode:c.getProperty("CompanyCode"),purchasingOrganization:c.getProperty("PurchasingOrganization")})}},onErrorShow:function(){var m=this.oBundle.getText("view.PR_List.no_price");ui.s2p.mm.purord.fromrequisition.Common.ShowErrorMessage(m)},onPRItem:function(e){var c=e.getSource().getBindingContext("PR_ass_model");var p=c.getProperty("PRKey");sap.ui.controller("ui.s2p.mm.purord.fromrequisition.view.FS_PR_Item").oParams.sCallerId=e.getSource().getId();sap.ui.controller("ui.s2p.mm.purord.fromrequisition.view.FS_PR_Item").oParams.sPath=c.getPath();sap.ui.controller("ui.s2p.mm.purord.fromrequisition.view.FS_PR_Item").oParams.oList=e.getSource().getParent().getParent().getBinding("items").aIndices;this.oRouter.navTo("pr_Item",{prKey:p})},exceptionFormatter:function(e){return(e)?"sap-icon://alert":""},exceptionColorFormatter:function(e){return(e)?sap.ui.core.theming.Parameters.get("sapUiNegative"):undefined},formatSourceOfSupply:function(s,p){return(s)?s:p},getVSDialogSort:function(){var t=this;if(t.oVSDialog){return t.oVSDialog}var v=new sap.m.ViewSettingsDialog({sortItems:[new sap.m.ViewSettingsItem({text:t.oBundle.getText("view.PR_List.column_id"),key:"PRKey",selected:true}),new sap.m.ViewSettingsItem({text:t.oBundle.getText("view.PR_List.column_supp"),key:"SupplierName"}),new sap.m.ViewSettingsItem({text:t.oBundle.getText("view.PR_List.column_mat"),key:"ProductDescription"}),new sap.m.ViewSettingsItem({text:t.oBundle.getText("view.PR_List.column_delivery"),key:"DeliveryDate"}),new sap.m.ViewSettingsItem({text:t.oBundle.getText("view.PR_List.column_val"),key:"Value"})],confirm:function(e){var p=e.getParameters();var B=t.oList.getBinding("items");var s=p.sortItem.getKey();var d=p.sortDescending;var S=new sap.ui.model.Sorter(s,d);if(s=="Value"){S.fnCompare=function(a,b){var V=parseFloat(a);var c=parseFloat(b);if(V<c){return-1}if(V>c){return 1}return 0}}B.sort(S)},});t.oVSDialog=v;return v}});
