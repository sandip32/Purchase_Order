/*
 * Copyright (C) 2009-2014 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.require("sap.ui.core.IconPool");jQuery.sap.require("ui.s2p.mm.purord.fromrequisition.util.Formatter");jQuery.sap.require("sap.ui.model.odata.Filter");jQuery.sap.require("sap.ca.scfld.md.controller.BaseFullscreenController");jQuery.sap.require("sap.ca.ui.utils.busydialog");sap.ca.scfld.md.controller.BaseFullscreenController.extend("ui.s2p.mm.purord.fromrequisition.view.PR_List",{onInit:function(){this.skip=0;this.packagesize=50;this.orderby="DeliveryDate desc";this.approvedPRs_all=0;this.approvedPRs_ui=0;this.oBundle=this.oApplicationImplementation.getResourceBundle();this.bResponderOn=jQuery.sap.getUriParameters().get("responderOn");this.bExceptionFilter=false;this.oList=this.byId("prlist");this.bWorkaround=true;this.oTableModel=new sap.ui.model.json.JSONModel();this.oTableModel.setSizeLimit(500);this.aFilter=[];var b=sap.ui.getCore().getEventBus();b.subscribe("ui.s2p.mm.purord.fromrequisition.popup","selection",this.receiveSelection,this);b.subscribe("ui.s2p.mm.purord.fromrequisition.publish","count",this.updateButtonText,this);if(this.bResponderOn){var p="/ui.s2p.mm.purord.fromrequisition/mock/unassignedPRsLikeMockup.json";this.oTableModel.loadData(p,"",true);if(this.oList){this.oList.setModel(this.oTableModel,"PR_appr_model")}}this.setTableHeader()},onBeforeRendering:function(){if(!this.oList){return}var l=this.oList.getModel("PR_appr_model");if(l===undefined&&this.bWorkaround){this.bWorkaround=false;this.oModel=this.oView.getModel("backendModel");var s="$skip="+this.skip;var t="$top="+this.packagesize;var o="$orderby="+this.orderby;var m=true;this.loadDataforView(s,t,o,m);sap.ui.getCore().getEventBus().publish("ui.s2p.mm.purord.fromrequisition.trigger","loadAssignedPRs");if(jQuery.device.is.phone){var a=this.oApplicationImplementation.getResourceBundle().getText('view.POfromPR.phone_warning');ui.s2p.mm.purord.fromrequisition.Common.ShowWarningMessage(a,"")}}},loadDataforView:function(s,t,o,m){if(!this.oList){return}var S;if(m===true){S=this.addToTableModel}else{S=this.refreshTableModel}this.oList.setNoDataText(this.oBundle.getText("view.POfromPR.loading_message"));sap.ca.ui.utils.busydialog.requireBusyDialog();this.oModel.read('PRItemCollection',null,[s,t,o,"$filter=SupplierId eq '' "],true,jQuery.proxy(S,this),jQuery.proxy(function(e){sap.ca.ui.utils.busydialog.releaseBusyDialog();var a=this.oBundle.getText('view.POfromPR.general_error_unassigned_message');this.oList.setNoDataText(a);var d="";if(e.message&&e.response){d=e.message+"\n"+e.response.requestUri+"\n"+e.response.statusText}ui.s2p.mm.purord.fromrequisition.Common.ShowErrorMessage(a,d)},this))},addToTableModel:function(d,r){var m=true;this.updateTableModel(d,r,m)},refreshTableModel:function(d,r){var m=false;this.updateTableModel(d,r,m)},updateTableModel:function(d,r,m){var c=this.byId("column2");var l=this.byId("l1");var a=undefined;if(l){a=l.getDomRef()}if(c&&a){c.setMinScreenWidth((a.clientWidth+1)+"px")}sap.ui.getCore().getEventBus().publish("ui.s2p.mm.purord.fromrequisition.publish","orientationChange",this);if(this.approvedPRs_all===0){this.approvedPRs_all=parseInt(d.__count)}if(m===true){this.approvedPRs_ui+=d.results.length}else{this.approvedPRs_ui=d.results.length}sap.ui.getCore().getEventBus().publish("ui.s2p.mm.purord.fromrequisition.publish","count",{count_prapproved:this.approvedPRs_all,count_loaded:this.approvedPRs_ui});jQuery.each(d.results,function(k,v){v.SupplierMultiple=false;v.HideMe=false;v.ItemSelected=true});sap.ui.getCore().getEventBus().publish("ui.s2p.mm.purord.fromrequisition.publish","updateIconTabColor",{btnPRreleasedColor:sap.ui.core.IconColor.Default});if(this.oTableModel.oData.PRItemCollection&&this.oTableModel.oData.PRItemCollection.length>0&&m===true){this.toggleListVisibility(true);jQuery.merge(this.oTableModel.oData.PRItemCollection,d.results)}else if(d.results.length==0&&(!this.oTableModel.oData.PRItemCollection||this.oTableModel.oData.PRItemCollection.length==0)){this.toggleListVisibility(false);sap.ca.ui.utils.busydialog.releaseBusyDialog();return}else{this.toggleListVisibility(true);this.oTableModel.setData({"PRItemCollection":d.results})}if(this.oList){this.oList.setModel(this.oTableModel,"PR_appr_model");this.oTableModel.refresh();sap.ca.ui.utils.busydialog.releaseBusyDialog();this.oList.setNoDataText("");this.refreshList()}},getList:function(){return this.byId("prlist")},onAssignSupplier:function(e){var I=[];if(this.oList){I=this.oList.getSelectedItems()}var r="";var p="";var c;var b=[];for(var i=0;i<I.length;i++){r="";c=I[i].getBindingContext("PR_appr_model");p=c.getProperty("PRKey");r="PRItemCollection('"+p+"')?$expand=SourcesOfSupplyCollection";b.push(this.oModel.createBatchOperation(r,"GET"))}if(b.length>0){sap.ca.ui.utils.busydialog.requireBusyDialog({text:this.oBundle.getText("view.POfromPR.assigning_message")});this.oModel.addBatchReadOperations(b);this.oModel.refreshSecurityToken(jQuery.proxy(this.callBatchAssignSuppliers,this),function(a){sap.ca.ui.utils.busydialog.releaseBusyDialog();ui.s2p.mm.purord.fromrequisition.Common.ShowErrorMessage("error refresh csrf token",a)},true)}},callBatchAssignSuppliers:function(){this.oModel.submitBatch(jQuery.proxy(this.getAssignResult,this),function(e){jQuery.sap.log.info(e.toString());jQuery.sap.log.info("error submit batch");sap.ca.ui.utils.busydialog.releaseBusyDialog();var m=sap.ca.scfld.md.app.Application.getImpl().getResourceBundle().getText('view.POfromPR.general_error_assign_message');var d="";if(e.message&&e.response){d=e.message+"\n"+e.response.requestUri+"\n"+e.response.statusText}ui.s2p.mm.purord.fromrequisition.Common.ShowErrorMessage(m,d)},true)},getIfItemInList:function(p,I){for(var i=0;i<I.length;i++){var P=ui.s2p.mm.purord.fromrequisition.util.Formatter.formatPRItem(p.PRNumberFormatted,p.PRItemFormatted);if(P===I[i].getCells()[0].getText()){return i}}return-1},getAssignResult:function(d,r,e){var I=[];var n=[];var R=[];var a=[];var m=0;var N=0;var A=0;var s;jQuery.each(d.__batchResponses,function(k,v){v.data.SupplierMultiple=false;v.data.HideMe=false;v.data.ItemSelected=true;s=0;if(v.data.SourcesOfSupplyCollection.results){s=v.data.SourcesOfSupplyCollection.results.length}if(s>1){v.data.SupplierMultiple=true;m+=1}else if(s===1){if(v.data.SourcesOfSupplyCollection.results[0].FixedVendor===""||v.data.SourcesOfSupplyCollection.results[0].Error===true){v.data.Error=true;N+=1}else{v.data.PRSourceKeys=v.data.SourcesOfSupplyCollection.results[0].PRSourceKeys;v.data.SupplierId=v.data.SourcesOfSupplyCollection.results[0].FixedVendor;v.data.SupplierName=v.data.SourcesOfSupplyCollection.results[0].FixedVendorName;v.data.OpenQuantityUnit=v.data.SourcesOfSupplyCollection.results[0].OpenQuantityUnit;v.data.OpenQuantityUnitDescription=v.data.SourcesOfSupplyCollection.results[0].OpenQuantityUnitDescription;v.data.OpenQuantity=v.data.SourcesOfSupplyCollection.results[0].OpenQuantity;v.data.OpenQuantityFormatted=v.data.SourcesOfSupplyCollection.results[0].OpenQuantityFormatted;v.data.Price=v.data.SourcesOfSupplyCollection.results[0].NetPrice;v.data.PriceFormatted=v.data.SourcesOfSupplyCollection.results[0].NetPriceFormatted;v.data.Value=v.data.SourcesOfSupplyCollection.results[0].NetOrderValue;v.data.ValueFormatted=v.data.SourcesOfSupplyCollection.results[0].NetOrderValueFormatted;v.data.Currency=v.data.SourcesOfSupplyCollection.results[0].Currency;v.data.PriceUnit=v.data.SourcesOfSupplyCollection.results[0].PriceUnit;v.data.OrderPriceUnit=v.data.SourcesOfSupplyCollection.results[0].OrderPriceUnit;v.data.OrderPriceUnitDescription=v.data.SourcesOfSupplyCollection.results[0].OrderPriceUnitDescription;v.data.PurchasingOrganization=v.data.SourcesOfSupplyCollection.results[0].PurchasingOrg;v.data.HideMe=true;a.push(v.data);A+=1}}else{N+=1}R.push(v.data)});sap.ca.ui.utils.busydialog.releaseBusyDialog();var l=this.oTableModel.oData.PRItemCollection.length;if(this.oList){I=this.oList.getItems()}for(var i=0;i<l;i++){var b=this.getIfItemInList(this.oTableModel.oData.PRItemCollection[i],I);if(b!=-1){if(I[b].getSelected()){for(var j=0,f=false;!f&&j<R.length;j++){if(this.oTableModel.oData.PRItemCollection[i].PRKey===R[j].PRKey){n.push(R[j]);f=true}}}else{n.push(this.oTableModel.oData.PRItemCollection[i])}}else{this.oTableModel.oData.PRItemCollection[i].HideMe=true;n.push(this.oTableModel.oData.PRItemCollection[i])}}if(a.length>0){var o=new sap.ui.model.json.JSONModel();o.setData({"PRItemCollection":a});sap.ui.getCore().getEventBus().publish("ui.s2p.mm.purord.fromrequisition.publish","assignedPRs",{oModel:o})}this.oTableModel.setData({"PRItemCollection":n});if(this.oList){this.oList.setModel(null);this.oList.setModel(this.oTableModel,"PR_appr_model");this.oTableModel.refresh();this.refreshList()}this.approvedPRs_all-=A;this.approvedPRs_ui-=A;sap.ui.getCore().getEventBus().publish("ui.s2p.mm.purord.fromrequisition.publish","count",{count_prapproved:this.approvedPRs_all,count_loaded:this.approvedPRs_ui});if(N>0){sap.ui.getCore().getEventBus().publish("ui.s2p.mm.purord.fromrequisition.publish","updateIconTabColor",{btnPRreleasedColor:sap.ui.core.IconColor.Negative})}else if(m>0){sap.ui.getCore().getEventBus().publish("ui.s2p.mm.purord.fromrequisition.publish","updateIconTabColor",{btnPRreleasedColor:sap.ui.core.IconColor.Critical})}else{sap.ui.getCore().getEventBus().publish("ui.s2p.mm.purord.fromrequisition.publish","updateIconTabColor",{btnPRreleasedColor:sap.ui.core.IconColor.Default})}var M="";var c="";var g="";if(m>0){M=m===1?this.oBundle.getText("view.POfromPR_Messages.assign_manual_sing"):this.oBundle.getText("view.POfromPR_Messages.assign_manual_plu",[m])}if(A>0){c=A===1?this.oBundle.getText("view.POfromPR_Messages.assigned_sing"):this.oBundle.getText("view.POfromPR_Messages.assigned_plu",[A])}if(N>0){g=N===1?this.oBundle.getText("view.POfromPR_Messages.not_assigned_sing"):this.oBundle.getText("view.POfromPR_Messages.not_assigned_plu",[N])}var h=M+'\n'+c+'\n'+g;jQuery.sap.require("sap.m.MessageToast");sap.m.MessageToast.show(h,{width:"30em",duration:6000})},onMultipleSupplier:function(e){var t;var d;if(!this.oSupplierPopup){this.oSupplierPopup=ui.s2p.mm.purord.fromrequisition.Common.getSupplierPopup(this.oTableModel,this.getView().getModel("i18n"),this.oRouter);this.oSupplierPopup.sOrigin="PR_List"}if(!this.oSupplierPopup){return}var c=e.getSource().getBindingContext("PR_appr_model");var p=c.getPath();var E=c.getProperty(p+"/Error");if(E){t=this.oBundle.getText("XTIT_MS_ERROR");d=this.oBundle.getText("view.PR_List.no_price")}else{t=this.oBundle.getText("view.POfromPR.assign_tit");d=this.oBundle.getText("view.MultipleSuppliers.title")}this.oSupplierPopup.setTitle(t);var s=undefined;if(this.bResponderOn){s=p+"/SourcesOfSupplyCollection"}else{s=p+"/SourcesOfSupplyCollection/results"}var b=sap.ui.getCore().getEventBus();b.publish("ui.s2p.mm.purord.fromrequisition.supplier","path",{path:s,itempath:p,backendModel:this.oList.getModel("PR_appr_model"),displayText:d});this.oSupplierPopup.openBy(e.getSource())},receiveSelection:function(c,e,d){if(!this.oList){return}if(d.sOrigin==="PR_List"){var n=[];var l=this.oTableModel.oData.PRItemCollection.length;var h=false;for(var i=0;i<l;i++){if(this.oTableModel.oData.PRItemCollection[i].PRKey===d.oPRItem.PRKey){this.oTableModel.oData.PRItemCollection[i].HideMe=true;this.oTableModel.oData.PRItemCollection[i].ItemSelected=true}else if(this.oTableModel.oData.PRItemCollection[i].AssignedSupplierCount>1&&!this.oTableModel.oData.PRItemCollection[i].HideMe===true){h=true}n.push(this.oTableModel.oData.PRItemCollection[i])}this.oTableModel.setData({"PRItemCollection":n});if(this.oList){this.oList.setModel(this.oTableModel,"PR_appr_model");this.refreshList()}this.approvedPRs_all-=1;this.approvedPRs_ui-=1;sap.ui.getCore().getEventBus().publish("ui.s2p.mm.purord.fromrequisition.publish","count",{count_prapproved:this.approvedPRs_all,count_loaded:this.approvedPRs_ui});if(h==true){sap.ui.getCore().getEventBus().publish("ui.s2p.mm.purord.fromrequisition.publish","updateIconTabColor",{btnPRreleasedColor:sap.ui.core.IconColor.Critical})}else{sap.ui.getCore().getEventBus().publish("ui.s2p.mm.purord.fromrequisition.publish","updateIconTabColor",{btnPRreleasedColor:sap.ui.core.IconColor.Default})}}},onLoadMoreData:function(e){if(this.oModel&&this.oModel.read){this.skip+=this.packagesize;var s="$skip="+this.skip;var t="$top="+this.packagesize;var o="$orderby="+this.orderby;var m=true;this.loadDataforView(s,t,o,m)}},filterValue:function(f){var F;switch(f){case"noFilter":this.bExceptionFilter=false;this.aFilter=[];break;case"withException":this.bExceptionFilter=true;F=new sap.ui.model.Filter("SupplierMultiple",sap.ui.model.FilterOperator.EQ,true);this.aFilter=[F];break;case"withoutException":this.bExceptionFilter=true;F=new sap.ui.model.Filter("SupplierMultiple",sap.ui.model.FilterOperator.EQ,false);this.aFilter=[F];break}this.refreshList()},updateButtonText:function(c,e,d){if(d.count_prapproved){var b=this.byId("btnLoad");var t=this.oBundle.getText("view.POfromPR.load_more");t+=" [ "+d.count_loaded+" / "+d.count_prapproved+" ] ";if(b){b.setText(t)}}},exceptionFormatter:function(a,e){var i="";if(e){i="sap-icon://alert"}else{var s=parseInt(a);if(s>=1){i="sap-icon://warning2"}}return i},exceptionColorFormatter:function(a,e){var c=undefined;var s=parseInt(a);if(e){c=sap.ui.core.theming.Parameters.get("sapUiNegative")}else{if(s>=1){c=sap.ui.core.theming.Parameters.get("sapUiCritical")}}return c},exceptionClassFormatter:function(a,e){var c="";var s=parseInt(a);if(e){c="sapMITFilterNegative"}else{if(s>=1){c="sapMITFilterCritical"}}return c},refreshList:function(){if(!this.oList){return}var l=this.oList.getBinding("items");var f=new sap.ui.model.Filter("HideMe",sap.ui.model.FilterOperator.EQ,false);var F=[];F.push(f);if(this.aFilter.length>0){jQuery.merge(F,this.aFilter)}if(l){l.filter(F,sap.ui.model.FilterType.Control)}},toggleListVisibility:function(v){if(this.oList){this.oList.setVisible(v)}var s=this.byId("ShowMore");if(s){s.setVisible(v)}var n=this.byId("NoData");if(n){n.setVisible(!v)}},onPRItem:function(e){var c=e.getSource().getBindingContext("PR_appr_model");var p=c.getProperty("PRKey");sap.ui.controller("ui.s2p.mm.purord.fromrequisition.view.FS_PR_Item").oParams.sCallerId=e.getSource().getId();sap.ui.controller("ui.s2p.mm.purord.fromrequisition.view.FS_PR_Item").oParams.sPath=c.getPath();sap.ui.controller("ui.s2p.mm.purord.fromrequisition.view.FS_PR_Item").oParams.oList=e.getSource().getParent().getParent().getBinding("items").aIndices;this.oRouter.navTo("pr_Item",{prKey:p})},setTableHeader:function(){var v=this.getVSDialogFilter();this.oList.setInfoToolbar(new sap.m.Toolbar({active:true,visible:false,press:function(e){v.open()},content:[new sap.m.Label({text:"?"}),new sap.m.ToolbarSpacer(),new sap.ui.core.Icon({src:"sap-icon://add-filter"})]}))},getVSDialogSort:function(){var t=this;if(t.oVSDialogSort){return t.oVSDialogSort}var v=new sap.m.ViewSettingsDialog({sortItems:[new sap.m.ViewSettingsItem({text:t.oBundle.getText("view.PR_List.column_id"),key:"PRKey",selected:true}),new sap.m.ViewSettingsItem({text:t.oBundle.getText("view.POfromPR.filte_exceptions"),key:"SupplierMultiple"}),new sap.m.ViewSettingsItem({text:t.oBundle.getText("view.PR_List.column_reldate"),key:"ReleaseDate"}),new sap.m.ViewSettingsItem({text:t.oBundle.getText("view.PR_List.column_mat"),key:"ProductDescription"}),new sap.m.ViewSettingsItem({text:t.oBundle.getText("view.PR_List.column_delivery"),key:"DeliveryDate"}),new sap.m.ViewSettingsItem({text:t.oBundle.getText("view.PR_List.column_val"),key:"Value"})],confirm:function(e){var p=e.getParameters();var B=t.oList.getBinding("items");var s=p.sortItem.getKey();var d=p.sortDescending;if(t.approvedPRs_all===t.approvedPRs_ui){var S=new sap.ui.model.Sorter(s,d);if(s=="Value"){S.fnCompare=function(a,b){var V=parseFloat(a);var f=parseFloat(b);if(V<f){return-1}if(V>f){return 1}return 0}}B.sort(S)}else{var c="$skip=0";var T="$top=50";t.orderbyAttr=s;if(d===true){t.orderby=t.orderbyAttr+" desc"}else{t.orderby=s}var o="$orderby="+t.orderby;var m=false;t.loadDataforView(c,T,o,m)}},});t.oVSDialogSort=v;return v},getVSDialogFilter:function(){var t=this;if(t.oVSDialogFilter){return t.oVSDialogFilter}var v=new sap.m.ViewSettingsDialog({presetFilterItems:[new sap.m.ViewSettingsFilterItem({text:t.oBundle.getText("view.POfromPR.filte_exceptions"),key:"withException",multiSelect:false,}),new sap.m.ViewSettingsFilterItem({text:t.oBundle.getText("view.POfromPR.filter_no_exceptions"),key:"withoutException",multiSelect:false,})],confirm:function(e){var p=e.getParameters();var T=false;if(!p.presetFilterItem){t.filterValue("noFilter")}else{var f=p.presetFilterItem.getKey();t.filterValue(f);T=true}var F=t.oList.getInfoToolbar();F.setVisible(T);var o=F.getContent()[0];o.setText(p.filterString)},});t.oVSDialogFilter=v;return v},});
